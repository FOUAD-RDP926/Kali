name: Kali Linux Mobile Pro
on: 
  workflow_dispatch:

jobs:
  kali-vnc:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Start Kali Kasm Desktop
        run: |
          # تشغيل النسخة الاحترافية (Password: password)
          # سحب الصورة قد يأخذ دقيقة، لا تقلق
          docker run -d --name kali-mobile --privileged -p 6080:6901 -e VNC_PW=password kasmweb/kali-rolling-desktop:1.14.0
          
      - name: Background Tools Install
        run: |
          # تثبيت الأدوات في الخلفية (مش هيعطلك عن الدخول)
          docker exec -u 0 -d kali-mobile bash -c "apt-get update && apt-get install -y impacket-scripts burpsuite binwalk"

      - name: Setup Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          echo "---------------------------------------------------"
          echo "جاري إنشاء رابط التوصيل... انتظر قليلاً"
          # تشغيل التانل
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          # انتظار 30 ثانية لضمان استقرار cloudflare
          sleep 30
          
          TUNNEL_URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | head -n 1)
          echo "✅ النظام جاهز الآن!"
          echo "رابط الدخول المباشر:"
          echo "$TUNNEL_URL"
          echo "---------------------------------------------------"
          echo "Username: kasm_user"
          echo "Password: password"
          echo "---------------------------------------------------"
          echo "⚠️ ملاحظة: لو فتحت الرابط ولقيته بيحمل، انتظر دقيقة لأن النظام بيقوم بالداخل"

      - name: Maintain Session
        run: sleep 21600
