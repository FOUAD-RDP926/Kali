name: Kali Linux Ultra Fast
on: 
  workflow_dispatch:

jobs:
  kali-vnc:
    runs-on: ubuntu-latest
    steps:
      - name: Start Pre-configured Kali
        run: |
          # استخدام صورة جاهزة تحتوي على VNC و NoVNC مسبقاً لتوفير الوقت
          docker run -d --name kali-fast -p 6080:6080 --privileged kali-linux-full-gui-vnc-example || \
          docker run -d --name kali-fast -p 6080:6080 --privileged akasaka/kali-linux-vnc
          
      - name: Background Tools Install
        run: |
          # تثبيت الأدوات الإضافية في الخلفية حتى لا تضطر للانتظار لفتح الشاشة
          docker exec -d kali-fast bash -c "apt-get update && apt-get install -y impacket-scripts burpsuite binwalk"

      - name: Setup Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          echo "---------------------------------------------------"
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          # فحص استجابة البورت قبل عرض الرابط
          timeout 60s bash -c 'until curl -s localhost:6080; do sleep 2; done'
          
          TUNNEL_URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | head -n 1)
          echo "✅ جاهز! الرابط سيفتح الآن بسرعة:"
          echo "$TUNNEL_URL/vnc.html?autoconnect=true&resize=remote"
          echo "---------------------------------------------------"

      - name: Maintain Session
        run: sleep 21600
        
